# OpenAPI Usage Guide

This guide explains how the AIQ project uses OpenAPI specifications to maintain API contracts between the backend and iOS client.

## Overview

The OpenAPI workflow ensures type-safe communication between backend and iOS:

```
Backend Pydantic Schemas
    ↓ (FastAPI auto-generates)
OpenAPI Spec (openapi.json)
    ↓ (CI exports & syncs)
iOS Package (AIQAPIClient)
    ↓ (Swift OpenAPI Generator)
Type-Safe Swift Client Code
```

### Key Files

| File | Purpose |
|------|---------|
| `docs/api/openapi.json` | **Source of truth** OpenAPI spec (auto-generated by CI) |
| `backend/export_openapi.py` | Export script that generates the spec |
| `ios/Packages/AIQAPIClient/Sources/AIQAPIClient/openapi.json` | iOS package copy (synced by CI) |
| `ios/scripts/sync_openapi_spec.sh` | Sync script for local development |

## Workflow

### 1. Backend Changes → OpenAPI Spec

When you modify Pydantic schemas in `backend/app/schemas/`:

1. **Local testing**: The spec updates automatically when running the dev server
2. **CI export**: On push to `main`, CI runs `export_openapi.py` and commits the result
3. **Breaking changes**: On PRs, CI detects breaking changes and comments on the PR

**Example: Adding a new field**

```python
# backend/app/schemas/user.py
class UserProfile(BaseModel):
    id: int
    email: str
    first_name: str
    new_field: str  # ← New field added
```

After merge to `main`, CI automatically:
- Exports updated `docs/api/openapi.json`
- Commits the change with message: `chore: Update OpenAPI spec [skip ci]`

### 2. OpenAPI Spec → iOS Client

The iOS app regenerates client code during build:

1. **Sync script**: `ios/scripts/sync_openapi_spec.sh` copies spec to iOS package
2. **Code generation**: Swift OpenAPI Generator plugin creates type-safe client code
3. **Build verification**: Build fails if spec is out of sync or has breaking changes

**To manually sync locally:**

```bash
cd ios
./scripts/sync_openapi_spec.sh
```

## Running the Export Locally

### Basic Export

Export with default settings (includes transforms):

```bash
cd backend
python export_openapi.py
```

This writes to `docs/api/openapi.json` with anyOf-to-nullable transformations applied.

### Custom Output Path

Export to a different location:

```bash
cd backend
python export_openapi.py /path/to/output.json
```

### Without Transforms

Export the raw OpenAPI 3.1 spec without anyOf-to-nullable transformations:

```bash
cd backend
python export_openapi.py --no-transform
```

**When to use `--no-transform`:**
- Debugging schema issues
- Validating against strict OpenAPI 3.1 validators
- Investigating client generator compatibility issues

### With Validation

Validate the spec structure before writing:

```bash
cd backend
python export_openapi.py --validate
```

**What validation checks:**
- Required fields present (`openapi`, `info`, `paths`)
- Schema structure is well-formed
- All `$ref` references resolve to defined schemas
- Returns exit code 5 if validation fails

### Combined Flags

You can combine flags:

```bash
# Validate but don't transform
python export_openapi.py --validate --no-transform

# Custom path with validation
python export_openapi.py /tmp/spec.json --validate
```

## Breaking Change Detection

CI automatically detects breaking API changes on pull requests.

### What Are Breaking Changes?

| Change Type | Example | Impact |
|-------------|---------|--------|
| **Removed endpoint** | Deleted `/v1/users` | iOS clients calling this endpoint will fail |
| **Removed HTTP method** | Removed `DELETE /v1/users/{id}` | Delete functionality breaks |
| **Removed required field** | Removed `email` from `UserProfile` | Swift code expecting this field fails to compile |
| **Field now required** | Made `phone_number` required | Requests without this field are rejected |
| **Changed type** | Changed `age` from `int` to `string` | Type mismatch causes runtime errors |
| **Removed schema** | Deleted `UserSettings` definition | All references to this schema break |

### How It Works

On pull requests that modify backend code:

1. **Export new spec**: CI generates OpenAPI spec from PR branch
2. **Compare**: Runs `scripts/detect_breaking_changes.py` against `main` branch spec
3. **Report**: Posts comment on PR if breaking changes found
4. **Review**: Team reviews changes and updates iOS client if needed

**Example CI output:**

```
⚠️ Breaking API Changes Detected

REMOVED_REQUIRED_FIELD:
  - components/schemas/UserProfile.phone_number
    Required field was removed

CHANGED_TYPE:
  - components/schemas/TestSession.score
    Type changed from integer to number

Please review these changes carefully and update the iOS client if needed.
```

### Running Locally

Test for breaking changes before pushing:

```bash
cd backend

# Export current spec
python export_openapi.py ../docs/api/openapi_new.json

# Compare against main branch
git show origin/main:docs/api/openapi.json > ../docs/api/openapi_old.json
python scripts/detect_breaking_changes.py ../docs/api/openapi_old.json ../docs/api/openapi_new.json

# Cleanup
rm ../docs/api/openapi_old.json ../docs/api/openapi_new.json
```

**Exit codes:**
- `0`: No breaking changes
- `1`: Breaking changes detected
- `2`: Error reading/parsing spec files

## CI Pipeline Details

### Backend CI Job: `export-openapi`

**Triggers:** Push to `main` branch

**Steps:**
1. Checkout code
2. Install Python dependencies
3. Export OpenAPI spec with temporary SQLite database
4. Clean up temporary database
5. Check if spec changed
6. Commit and push if changed (with retry logic for concurrency)

**Environment variables:**
- `DATABASE_URL`: SQLite for spec generation (no real DB needed)
- Auth tokens: Dummy values (not used during spec generation)

### Backend CI Job: `check-breaking-changes`

**Triggers:** Pull requests

**Steps:**
1. Export OpenAPI spec from PR branch
2. Get OpenAPI spec from `main` branch
3. Run breaking changes detection
4. Comment on PR if changes found
5. Clean up temporary files

## iOS CI Verification

The iOS CI pipeline (`ios-ci.yml`) verifies spec sync:

```yaml
- name: Verify OpenAPI spec is in sync
  run: |
    diff -q docs/api/openapi.json \
      ios/Packages/AIQAPIClient/Sources/AIQAPIClient/openapi.json
```

**If this check fails:**

```bash
cd ios
./scripts/sync_openapi_spec.sh
git add ios/Packages/AIQAPIClient/Sources/AIQAPIClient/openapi.json
git commit -m "chore: Sync OpenAPI spec to iOS package"
```

## Adding New Endpoints

### Step 1: Define Pydantic Schemas

Create request/response schemas in `backend/app/schemas/`:

```python
# backend/app/schemas/feature.py
from pydantic import BaseModel, Field

class FeatureRequest(BaseModel):
    """Request schema for feature endpoint."""
    name: str = Field(..., min_length=1, max_length=100)
    enabled: bool = True

class FeatureResponse(BaseModel):
    """Response schema for feature endpoint."""
    id: int
    name: str
    enabled: bool
    created_at: str
```

### Step 2: Create Endpoint

Define the endpoint in `backend/app/api/v1/`:

```python
from fastapi import APIRouter, Depends
from app.schemas.feature import FeatureRequest, FeatureResponse
from app.core.auth import get_current_user

router = APIRouter(prefix="/feature", tags=["feature"])

@router.post("/", response_model=FeatureResponse)
def create_feature(
    data: FeatureRequest,
    current_user: User = Depends(get_current_user),
) -> FeatureResponse:
    """Create a new feature."""
    # Implementation here
    return FeatureResponse(...)
```

### Step 3: CI Handles the Rest

1. **Push to branch**: CI runs tests
2. **Open PR**: CI detects this is a new endpoint (no breaking changes)
3. **Merge to main**: CI exports updated spec and commits it
4. **iOS sync**: Next iOS build pulls updated spec and regenerates client

### Step 4: Use in iOS

The generated Swift client is automatically available:

```swift
// iOS client code
let request = Components.Schemas.FeatureRequest(
    name: "New Feature",
    enabled: true
)

let response = try await apiClient.createFeature(body: .json(request))
```

## Common Scenarios

### Scenario: "I modified a schema but the spec didn't update"

**Check:**
1. Did you restart the dev server? FastAPI caches the spec.
2. Did the changes merge to `main`? Spec only auto-updates on `main` pushes.
3. Check CI logs for `export-openapi` job failures.

**Manual fix:**
```bash
cd backend
python export_openapi.py
git add ../docs/api/openapi.json
git commit -m "chore: Update OpenAPI spec"
```

### Scenario: "iOS build fails with 'OpenAPI spec out of sync'"

**Fix:**
```bash
cd ios
./scripts/sync_openapi_spec.sh
# Build should now succeed
```

### Scenario: "I want to add an optional field without breaking clients"

**Good practice:**
```python
class UserProfile(BaseModel):
    id: int
    email: str
    phone: Optional[str] = None  # ← Optional, no breaking change
```

Optional fields don't break existing clients. They can ignore the new field.

### Scenario: "I need to remove a field"

**Best practice:**
1. **Deprecate first**: Mark field as deprecated in current release
2. **Update iOS**: Remove iOS code that uses the field
3. **Deploy iOS**: Ensure new iOS version is widely adopted
4. **Remove field**: After iOS update is deployed, remove from backend

**Add deprecation notice:**
```python
class UserProfile(BaseModel):
    id: int
    email: str
    old_field: Optional[str] = Field(
        None,
        deprecated=True,
        description="Deprecated: Use new_field instead"
    )
```

## Troubleshooting

### "Error: Failed to import FastAPI app"

**Cause**: Dependencies not installed or import path issues.

**Fix:**
```bash
cd backend
source venv/bin/activate
export PYTHONPATH="${PYTHONPATH}:$(cd .. && pwd)"
python export_openapi.py
```

### "Error: Invalid output path"

**Cause**: Path traversal attempt detected (security feature).

**Fix**: Only export to paths within the project directory:
```bash
# Good
python export_openapi.py ../docs/api/openapi.json

# Bad (blocked)
python export_openapi.py ../../etc/passwd
```

### "Warning: Failed to apply transforms"

**Cause**: Transform function error (non-fatal).

**Effect**: Spec exports without anyOf-to-nullable transformations.

**Fix**: Check transform function in `backend/app/core/openapi_transforms.py`.

### "Validation failed: Unresolved $ref"

**Cause**: Schema references a non-existent component.

**Fix**: Ensure all referenced schemas are defined in `components/schemas/`.

## Best Practices

### 1. Always Use Pydantic Schemas

```python
# Good - Type-safe and generates OpenAPI
@router.post("/items", response_model=ItemResponse)
def create_item(data: ItemCreate) -> ItemResponse:
    ...

# Bad - No type safety or OpenAPI generation
@router.post("/items")
def create_item(data: dict) -> dict:
    ...
```

### 2. Document Your Schemas

```python
class UserProfile(BaseModel):
    """User profile information returned by the API."""

    id: int = Field(..., description="Unique user identifier")
    email: str = Field(..., description="User's email address")
```

Documentation appears in OpenAPI spec and generated iOS client.

### 3. Use Semantic Versioning

When making breaking changes:
- **Major version**: Breaking changes (v1 → v2)
- **Minor version**: New features, backward compatible
- **Patch version**: Bug fixes

Update the version in `backend/app/main.py`:
```python
app = FastAPI(
    title="AIQ API",
    version="2.0.0",  # ← Update for breaking changes
)
```

### 4. Test Before Merging

Before opening a PR:
```bash
# Run backend tests
cd backend
pytest

# Export spec locally
python export_openapi.py

# Check for breaking changes
python scripts/detect_breaking_changes.py \
    <(git show origin/main:docs/api/openapi.json) \
    ../docs/api/openapi.json
```

### 5. Keep Specs in Sync

Never manually edit `docs/api/openapi.json`. If you need to make changes:
1. Modify Pydantic schemas
2. Let CI regenerate the spec
3. iOS will pick up changes automatically

## References

- [OpenAPI Specification 3.1.0](https://spec.openapis.org/oas/v3.1.0)
- [FastAPI OpenAPI Documentation](https://fastapi.tiangolo.com/tutorial/metadata/)
- [Swift OpenAPI Generator](https://github.com/apple/swift-openapi-generator)
- [iOS OpenAPI Usage Guide](../ios/docs/OPENAPI_USAGE_GUIDE.md) (iOS-specific)
