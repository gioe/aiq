# IQ Tracker Backend

Backend API server for the IQ Tracker application.

## Responsibilities

- User authentication and account management
- Serving IQ test questions to iOS app
- Storing user responses and test results
- Calculating scores and generating insights/trends
- Managing push notification scheduling
- Tracking which questions each user has answered

## Tech Stack

- **Language/Framework**: Python 3.10+ with FastAPI
- **Database**: PostgreSQL 14+
- **ORM**: SQLAlchemy
- **Migrations**: Alembic
- **Authentication**: JWT with Bcrypt
- **API Documentation**: Swagger/OpenAPI (auto-generated by FastAPI)

## API Endpoints

(To be designed)

### Planned Endpoints:
- Authentication (login, register, token refresh)
- User profile management
- Question fetching (with logic to exclude already-answered questions)
- Response submission
- Results and insights retrieval
- Notification preferences

## Database Schema

(To be designed)

### Planned Tables:
- `users` - User accounts and profiles
- `questions` - IQ test questions pool
- `user_questions` - Tracks which questions each user has seen
- `responses` - User answers to questions
- `test_results` - Aggregated test scores over time
- `notifications` - Notification scheduling and history

## Setup

### Prerequisites

- Python 3.10 or higher
- PostgreSQL 14 or higher
- pip (Python package manager)

### 1. Database Setup

#### Install PostgreSQL

**macOS (using Homebrew):**
```bash
brew install postgresql@14
brew services start postgresql@14
```

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib
sudo systemctl start postgresql
```

**Windows:**
Download and install from [postgresql.org](https://www.postgresql.org/download/windows/)

#### Create Databases

Once PostgreSQL is installed and running, create the development and test databases:

```bash
# Connect to PostgreSQL
psql -U <your-username> -d postgres

# Create databases
CREATE DATABASE iq_tracker_dev;
CREATE DATABASE iq_tracker_test;

# Verify creation
\l

# Exit
\q
```

Replace `<your-username>` with your system username (typically the same as your macOS/Linux username).

### 2. Environment Configuration

Copy the example environment file and configure it:

```bash
cp .env.example .env
```

Edit `.env` and update the following values:
- `DATABASE_USER`: Your PostgreSQL username
- `DATABASE_PASSWORD`: Your PostgreSQL password (if set)
- `DATABASE_URL`: Full connection string (update username/password if needed)
- `SECRET_KEY`: Generate a secure random string
- `JWT_SECRET_KEY`: Generate a different secure random string

**Example for local development (macOS/Linux):**
```env
DATABASE_URL=postgresql://yourusername@localhost:5432/iq_tracker_dev
TEST_DATABASE_URL=postgresql://yourusername@localhost:5432/iq_tracker_test
```

### 3. Python Environment

Create and activate a virtual environment, then install dependencies:

```bash
# Navigate to backend directory
cd backend

# Create virtual environment
python3 -m venv venv

# Activate virtual environment
# macOS/Linux:
source venv/bin/activate
# Windows:
# venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

**Verify installation:**
```bash
python -c "import fastapi; import sqlalchemy; print('Dependencies installed successfully')"
```

### 4. Run Migrations

Apply database migrations to create the schema:

```bash
# Make sure you're in the backend directory with venv activated
alembic upgrade head
```

**Verify migrations:**
```bash
psql -U <your-username> -d iq_tracker_dev -c "\dt"
```

You should see the following tables:
- users
- questions
- test_sessions
- responses
- test_results
- user_questions
- alembic_version

**Create a new migration (when needed):**
```bash
alembic revision --autogenerate -m "Description of changes"
```

### 5. Start Development Server

Run the FastAPI development server with auto-reload:

```bash
# Make sure you're in the backend directory with venv activated
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

The API will be available at:
- **API Root**: http://localhost:8000/
- **API Docs (Swagger)**: http://localhost:8000/v1/docs
- **API Docs (ReDoc)**: http://localhost:8000/v1/redoc
- **OpenAPI Schema**: http://localhost:8000/v1/openapi.json

**Test the server:**
```bash
curl http://localhost:8000/
```

You should see:
```json
{
  "message": "Welcome to IQ Tracker API",
  "version": "0.1.0",
  "docs": "/v1/docs"
}
```

## Development

### Running Tests

```bash
# Make sure venv is activated
pytest
```

### Code Quality

This project uses automated code quality tools:
- **black**: Code formatting
- **flake8**: Linting
- **mypy**: Static type checking

Run all checks:
```bash
black . --check
flake8 .
mypy app/
```

Auto-format code:
```bash
black .
```

### Common Development Tasks

**Check database connection:**
```bash
python -c "from app.core.database import engine; print('Database connected:', engine.url)"
```

**Reset database (caution - deletes all data):**
```bash
alembic downgrade base
alembic upgrade head
```

**View migration history:**
```bash
alembic history
alembic current
```

### Project Structure

```
backend/
├── app/
│   ├── main.py           # FastAPI application entry point
│   ├── api/              # API routes and endpoints
│   ├── core/             # Core configuration and settings
│   └── models/           # SQLAlchemy database models
├── alembic/              # Database migrations
│   └── versions/         # Migration scripts
├── requirements.txt      # Python dependencies
├── alembic.ini          # Alembic configuration
├── .env                 # Local environment variables (gitignored)
└── .env.example         # Example environment file
```

## Deployment

(To be added)
