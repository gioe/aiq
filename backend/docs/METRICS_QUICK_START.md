# Prometheus Metrics - Quick Start Guide

Get Prometheus metrics up and running in 5 minutes.

## 1. Install Dependencies

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

This installs:
- `opentelemetry-exporter-prometheus==0.51b0`
- `prometheus-client==0.21.0`

## 2. Enable Metrics

Add to your `.env` file:

```bash
# Enable OpenTelemetry
OTEL_ENABLED=true
OTEL_METRICS_ENABLED=true

# Enable Prometheus metrics endpoint
PROMETHEUS_METRICS_ENABLED=true
```

## 3. Start the Backend

```bash
uvicorn app.main:app --reload
```

You should see in the logs:

```
INFO - OpenTelemetry metrics initialized with console exporter
INFO - Prometheus exporter initialized successfully
INFO - Application metrics initialized successfully
```

## 4. Verify Metrics Endpoint

```bash
curl http://localhost:8000/v1/metrics
```

Expected output:

```
# HELP http_server_requests Total HTTP requests
# TYPE http_server_requests counter
http_server_requests{http_method="GET",http_route="/v1/health",http_status_code="200"} 1.0
# HELP test_sessions_active Number of active test sessions
# TYPE test_sessions_active gauge
test_sessions_active 0.0
...
```

## 5. Set Up Prometheus (Optional)

### Using Docker Compose

```bash
cd backend/docs/examples
docker-compose -f docker-compose-monitoring.yml up -d
```

Access:
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin)

### Manual Setup

1. Install Prometheus:
   ```bash
   # macOS
   brew install prometheus

   # Linux
   wget https://github.com/prometheus/prometheus/releases/latest/download/prometheus-*.linux-amd64.tar.gz
   tar xvf prometheus-*.tar.gz
   cd prometheus-*
   ```

2. Configure Prometheus:
   ```bash
   cp backend/docs/examples/prometheus.yml .
   ```

3. Start Prometheus:
   ```bash
   prometheus --config.file=prometheus.yml
   ```

4. Access Prometheus UI: http://localhost:9090

## 6. View Metrics in Prometheus

In the Prometheus UI (http://localhost:9090), try these queries:

```promql
# Request rate
rate(http_server_requests[5m])

# Active test sessions
test_sessions_active

# Request latency (95th percentile)
histogram_quantile(0.95, rate(http_server_request_duration_bucket[5m]))
```

## 7. Import Grafana Dashboard (Optional)

If using Grafana:

1. Open http://localhost:3000 (login: admin/admin)
2. Add Prometheus data source:
   - Configuration → Data Sources → Add data source
   - Select "Prometheus"
   - URL: `http://prometheus:9090` (or `http://localhost:9090` if not using Docker)
   - Save & Test
3. Import dashboard:
   - Dashboards → Import
   - Copy JSON from [docs/PROMETHEUS_METRICS.md](PROMETHEUS_METRICS.md#example-grafana-dashboard-json)
   - Select Prometheus data source
   - Import

## Available Metrics

| Metric | Type | Description |
|--------|------|-------------|
| `http_server_requests` | Counter | Total HTTP requests by method, route, status |
| `http_server_request_duration` | Histogram | Request latency in seconds |
| `db_query_duration` | Histogram | Database query duration |
| `test_sessions_active` | Gauge | Current active test sessions |
| `test_sessions_started` | Counter | Total tests started |
| `test_sessions_completed` | Counter | Total tests completed |
| `test_sessions_abandoned` | Counter | Total tests abandoned |
| `questions_generated` | Counter | Questions generated by AI |
| `questions_served` | Counter | Questions served to users |
| `users_registrations` | Counter | New user registrations |
| `app_errors` | Counter | Application errors by type |

## Troubleshooting

### Metrics endpoint returns 503

**Problem:** `/v1/metrics` returns "Metrics not enabled"

**Solution:** Check your `.env` file:
```bash
OTEL_ENABLED=true
OTEL_METRICS_ENABLED=true
PROMETHEUS_METRICS_ENABLED=true
```

Restart the backend after changing `.env`.

### No metrics showing up

**Problem:** Endpoint returns empty or minimal metrics

**Solution:**
1. Generate some traffic:
   ```bash
   for i in {1..10}; do curl http://localhost:8000/v1/health; done
   ```
2. Wait for export interval (60 seconds default)
3. Check metrics again

### Prometheus can't scrape

**Problem:** Prometheus shows target as "DOWN"

**Solution:**
1. Verify backend is running: `curl http://localhost:8000/v1/metrics`
2. Check Prometheus config points to correct host/port
3. Check firewall rules if running on different machines

### Import errors

**Problem:** `ImportError: No module named 'prometheus_client'`

**Solution:**
```bash
pip install -r requirements.txt
```

## Next Steps

- **Full Documentation:** [PROMETHEUS_METRICS.md](PROMETHEUS_METRICS.md)
- **Instrumentation Guide:** [METRICS_INSTRUMENTATION.md](METRICS_INSTRUMENTATION.md)
- **Example Configurations:** [docs/examples/](examples/)
- **Set up alerts:** See [prometheus-rules.yml](examples/prometheus-rules.yml)

## Production Deployment

For production deployment:

1. **Set conservative sample rate:**
   ```bash
   OTEL_TRACES_SAMPLE_RATE=0.1  # 10% sampling
   ```

2. **Configure OTLP exporter for Grafana Cloud:**
   ```bash
   OTEL_EXPORTER=otlp
   OTEL_OTLP_ENDPOINT=https://otlp-gateway-prod-us-east-0.grafana.net/otlp
   OTEL_EXPORTER_OTLP_HEADERS=Authorization=Bearer <your-grafana-cloud-token>
   ```

3. **Keep Prometheus scraping enabled:**
   ```bash
   PROMETHEUS_METRICS_ENABLED=true
   ```

4. **Configure Prometheus to scrape production endpoint:**
   ```yaml
   # prometheus.yml
   scrape_configs:
     - job_name: 'aiq-backend-production'
       scheme: https
       static_configs:
         - targets: ['aiq-backend-production.up.railway.app']
       metrics_path: '/v1/metrics'
   ```

5. **Set up alerting rules** (see [prometheus-rules.yml](examples/prometheus-rules.yml))

## Support

For issues or questions:
- Check [PROMETHEUS_METRICS.md](PROMETHEUS_METRICS.md) for detailed documentation
- Review [METRICS_INSTRUMENTATION.md](METRICS_INSTRUMENTATION.md) for code examples
- Check logs: `grep -i metrics logs/app.log`
